---
output: 
  word_document:
    reference_docx: C:\Users\Martin Pastoors\AppData\Roaming\Microsoft\QuickStyles\Rmarkdown style.dotx
---

```{r setup, include=FALSE}

require("knitr")
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, crop = TRUE, comment = "")
knit_hooks$set(crop = hook_pdfcrop)
opts_knit$set(root.dir="D:/XXX/PRF/")
```


```{r initialization, include=FALSE}
################################################################################
# WGWIDE 2017 HOM catch analysis
#
# HOM catch analysis.Rmd"
# 
# 03/07/2017 Adapted from NSAS herring code
# 28/08/2017 Updated with new data and variables
# 28/08/2017 Updated with new csv output files
# 30/08/2017 Added southern horse mackerel
# 31/08/2017 Now plotting only the sampled catches
# 07/09/2017 Converted to Rmarkdown
################################################################################

rm(list=ls())

# library(devtools)
# install.packages("FLCore", repos="http://flr-project.org/R")

# Open libraries
# library(FLCore)
library(tidyverse)
library(readxl)
library(lubridate)
library(RColorBrewer)
library(directlabels)
library(cowplot)

# library(devtools); install_github("einarhjorleifsson/ggmisc")
library(ggmisc)

# set path
path    <- "D:/WGWIDE/2017/08. Personal folders/gersom/"
setwd(paste(path))

# Load utils code
source("D:/GIT/mptools/r/my_utils.r")

# set colour scheme
PAIRED <- rep(brewer.pal(12, "Paired"), 100)


# ============================================================================
# load catch data (catch, )
# ============================================================================

# generate file lists
catchfiles1  <- list.files(
  path       = paste(path,"outputs_intercatch_homw/catch_data/",sep=""),
  pattern    = "catch",
  recursive  = T, full.names = TRUE, ignore.case= TRUE)

catchfiles2  <- list.files(
  path       = paste(path,"outputs_intercatch_nshom/catch_data/",sep=""),
  pattern    = "catch",
  recursive  = T, full.names = TRUE, ignore.case= TRUE)

catchfiles <- c(catchfiles1, catchfiles2)
catchfiles <- catchfiles[!grepl("\\~",catchfiles)]

# read the data
# i <- 1
for (i in 1:length(catchfiles)){                                           
  
  print(paste(i, catchfiles[i], sep=" "))
  tmp <-  
    read_csv(file=catchfiles[i], col_names=TRUE) %>% 
    lowcase() %>% 
    mutate_at(names(.),funs(as.character))
  
  print(names(tmp))

  if (i==1) catch <- tmp else 
            catch <- rbind(catch,tmp)
} 

# set column types
catch <-
  catch %>% 
  mutate_at(c("year","season","caton","officiallandings","sampledcatch",
              "nooflengthsamples","nooflengthmeasured","noofagesamples", 
              "noagereadings"), funs(as.numeric) ) %>% 
  mutate(stock = ifelse(stock == "hom.27.3a4bc7d","hom-nsea",stock),
         area  = gsub("^27\\." , "", area),
         area  = gsub("\\.nshm", "", area),
         area  = gsub("\\."    , "", area),
         area  = substr(area,1,2)) %>% 
  data.frame()


# ============================================================================
# load by age files: canum, weight and length data
# ============================================================================

# generate file lists
byagefiles1  <- list.files(
  path       = paste(path,"outputs_intercatch_homw/catch_data/",sep=""),
  pattern    = "length",
  recursive  = T, full.names = TRUE, ignore.case= TRUE)

byagefiles2  <- list.files(
  path       = paste(path,"outputs_intercatch_nshom/catch_data/",sep=""),
  pattern    = "length",
  recursive  = T, full.names = TRUE, ignore.case= TRUE)

byagefiles <- c(byagefiles1, byagefiles2)
byagefiles <- byagefiles[!grepl("\\~",byagefiles)]

# read the data
# i <- 1
for (i in 1:length(byagefiles)){                                           
  
  print(paste(i, byagefiles[i], sep=" "))
  tmp <-  
    read_csv(file=byagefiles[i], col_names=TRUE) %>% 
    lowcase() %>% 
    mutate_at(names(.),funs(as.character))
  
  print(names(tmp))
  
  if (i==1) byage <- tmp else 
            byage <- rbind(byage,tmp)
} 

# set column types
byage <-
  byage %>% 
  mutate_at(c("year","season","caton","officiallandings","ageorlength",
              "canum","weca","leca","sampledcatch", "nooflengthsamples", 
              "nooflengthmeasured", "noofagesamples", 
              "noagereadings"), funs(as.numeric) ) %>% 
  mutate(stock = ifelse(stock == "hom.27.3a4bc7d","hom-nsea",stock),
         area  = gsub("^27\\." , "", area),
         area  = gsub("\\.nshm", "", area),
         area  = gsub("\\."    , "", area),
         area  = substr(area,1,2)) %>% 
  rename(age = ageorlength) %>% 
  data.frame()


# ============================================================================
# optional: read southern horse mackerel data
# ============================================================================

cn <- read_excel("hom-soth.xlsx", sheet = "canum", col_names = TRUE, skip = 0) %>% 
  gather(key=age, value=canum, a0:a11) %>% 
  mutate(age = as.numeric(gsub("a","", age)),
         canum   = 1000 * canum, 
         stock   ="hom-soth",
         area    = "9a")

wc <- read_excel("hom-soth.xlsx", sheet = "weca", col_names = TRUE, skip = 0) %>% 
  gather(key=age, value=weca, a0:a11) %>% 
  mutate(age = as.numeric(gsub("a","", age)),
         weca  = 1000*weca,
         stock   ="hom-soth",
         area    = "9a")

t <- cn %>%
  left_join(wc, by=c("stock","area","year","age")) %>% 
  data.frame()

ct <- read_excel("hom-soth.xlsx", sheet = "caton", col_names = TRUE, skip = 0) %>% 
  mutate(caton    = 1000*as.numeric(caton), 
         stock   ="hom-soth",
         area    = "9a") %>% 
  data.frame()

# ============================================================================
# combine data
# ============================================================================

rbya <-
  rbind.all.columns(byage, t) %>% 
  filter(year >= 2000)

rby <-
  rbind.all.columns(catch, ct) %>% 
  filter(year >= 2000)

# ============================================================================
# colour set
# ============================================================================



```

# Horse mackerel catch analysis for WGWIDE 2017

&nbsp;  

Martin Pastoors, `r format(Sys.time(), '%d/%m/%Y')`

&nbsp;  
&nbsp;  

## Introduction

Three stocks of horse mackerel (Trachurus trachurus) are indentified with the ICES scientific advice on that species: North Sea horse mackerel (hom-nsea), Western horse mackerel (hom-west) and Southern horse mackerel (hom-soth). 

Even though the data on these stocks are normally presented in separate sections, here we bring together data on all stocks in order to evaluate similarities and differences between areas and stocks. In addition, we are focussing on the age compositions of the catches in different areas to help in understanding the recruitment patterns and changes in selectivity in the fisheries for horse mackerel. Different ways of visualizing are used to explore the trends in different areas and seasons. 

## Data and methods

Catch at age data by stock, area and quarter were extracted from the Intercatch database for the years 2000-2016. The data is resolved by stock, year, quarter and area (division). 

The data for southern horse mackerel in area 9a were manually added by reading in data from the WG report (WGHANSA 2016). This data was only available by year.

## Results



_Figure 1: catches in tonnes by area_

```{r catch_stock, echo=FALSE, fig.width=10, fig.asp=.8, fig.align="center", message=FALSE, warning=FALSE}

p1 <-
  rby %>% 
  group_by(stock, year) %>%
  summarise(catch = sum(caton, na.rm=TRUE)) %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) +
  geom_bar(aes(fill=(stock)), stat="identity") +
  scale_fill_manual(values = PAIRED[1:3]) +
  guides(fill = guide_legend(nrow = 1)) +
  labs(y="tonnes", title="Horse mackerel catch by stock (tonnes)")

p2 <-
  rby %>% 
  group_by(stock, year) %>%
  summarise(catch = sum(caton, na.rm=TRUE)) %>% 
  ggplot(aes(x=year, y=catch)) +
  theme_publication() +
  theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), "cm")) +
  geom_bar(aes(fill=(stock)), stat="identity", position="fill") +
  scale_fill_manual(values = PAIRED[1:3]) +
  guides(fill = guide_legend(nrow = 1))

plot_grid(p1 + theme(legend.position = "none", 
                     axis.title.x    = element_blank(),
                     axis.text.x     = element_blank()) , 
          p2,  
          ncol=1, align = 'v', rel_heights = c(0.5,0.6))
```

##### page break

